<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <title>Scotland Yard</title>
    <link rel="stylesheet" href="/styles/main.css">
    <title>Lobby | Scotland Yard</title>
</head>

<body>

    <div class="layout-transparent mdl-layout mdl-js-layout">
        <header class="mdl-layout__header mdl-layout__header--transparent">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title display-1">Scotland Yard</span>
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link" href="/help.html">Help</a>

                </nav>
            </div>
        </header>

        <main class="mdl-layout__content">
            <div class="container">
                <div id="gamecodebox">
                    <span id="link"></span>
                </div>
                <div>
                    <ul id="players"></ul>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/ws_lobby_protocol.js"></script>

    <script>
        const player_id = '<%= player_id %>';
        const game_id = '<%= game_id %>';
        const name = '<%= name %>';
        const color = '<%= player_info.color %>';
        const isMrX = '<%= player_info.isMrX %>' === 'true';
        const players = [];
        document.getElementById('link').innerText = window.location.host + '/' + game_id;

        let socket = io();
        const Messages = this.LobbyMessages;

        let connectedObj = Messages.CONNECT;
        connectedObj.data.player_id = player_id;
        connectedObj.data.name = name;
        connectedObj.data.color = color;
        connectedObj.data.isMrX = isMrX;
        socket.emit(Messages.CONNECT.type, JSON.stringify(connectedObj));

        socket.on(Messages.ACKNOWLEDGE.type, (msg) => {
            let data = JSON.parse(msg).data;
            console.log("connected to", data.game_id)
            console.log("connected players:", data.players);
            data.players.forEach(player => {
                players.push(player);
            });            
            updateList();
        });
        socket.on(Messages.PLAYER_CONNECTED.type, msg => {
            let data = JSON.parse(msg).data;
            console.log("player joined: ", data);
            if (data.player_id === player_id) return;
            else players.push(data.name);
            updateList();
        });
        function updateList() {
            let html = "";
            players.forEach(player => {
                html += "<li>" + player + "</li>";
            });
            document.getElementById("players").innerHTML = html;
        }
    </script>
</body>

</html>